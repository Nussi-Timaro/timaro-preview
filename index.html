<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timaro Preview</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#f1c24c;
      --danger:#ff5b6b;
      --ok:#46d39a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1000px 600px at 20% 0%, rgba(95,146,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(241,194,76,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:760px;margin:0 auto;padding:20px 14px 28px;}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
    h1{font-size:26px;margin:4px 0 0;letter-spacing:.2px;}
    .pill{font-size:13px;padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;color:var(--muted);background:rgba(255,255,255,.03);white-space:nowrap;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .field{display:flex;flex-direction:column;gap:8px;}
    label{font-size:13px;color:var(--muted);letter-spacing:.2px;}
    input, select, button, textarea{font:inherit;}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      outline:none;
      background:rgba(0,0,0,.18);
      color:var(--text);
    }
    textarea{min-height:90px; resize:vertical;}
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.35);}
    input:focus, select:focus, textarea:focus{border-color:rgba(241,194,76,.45);box-shadow:0 0 0 3px rgba(241,194,76,.12);}
    .row{display:flex;gap:10px;align-items:center;}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      padding:12px 14px;
      border-radius:14px;
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:translateY(1px);}
    .btn-primary{background:var(--accent);border-color:rgba(0,0,0,.25);color:#1a1406;font-weight:700;}
    .btn-small{padding:11px 12px;white-space:nowrap;}
    .btn-inline{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:800;
      border:1px solid rgba(241,194,76,.35);
      background:rgba(241,194,76,.10);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      white-space:nowrap;
    }
    .hint{margin-top:10px;font-size:13px;color:var(--muted);line-height:1.35;}
    .stats{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .stat{border:1px solid var(--stroke);border-radius:16px;padding:12px;background:rgba(0,0,0,.14);}
    .stat .k{font-size:13px;color:var(--muted);margin-bottom:6px;}
    .stat .v{font-size:22px;font-weight:800;letter-spacing:.2px;}
    .divider{height:1px;background:var(--stroke);margin:14px 0;}
    .error{
      margin-top:10px;
      border:1px solid rgba(255,91,107,.35);
      background:rgba(255,91,107,.10);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      display:none;
      line-height:1.35;
    }
    .error .line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .ok{border:1px solid rgba(70,211,154,.30);background:rgba(70,211,154,.08);}
    .footer-actions{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .badge{
      display:inline-flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);
      border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);
    }
    .badge strong{color:rgba(255,255,255,.92);}
    .list{margin-top:14px;}
    .list h2{font-size:16px;margin:0 0 10px;color:rgba(255,255,255,.86);letter-spacing:.2px;}
    .item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--stroke);
      border-radius:16px;background:rgba(0,0,0,.14);margin-bottom:10px;
    }
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .item .date{font-weight:800;}
    .item .meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px;}

    .locked{opacity:.45;filter:grayscale(1);pointer-events:none;user-select:none;}
    .lockline{
      margin-top:10px;border:1px dashed rgba(255,255,255,.18);border-radius:14px;padding:10px 12px;
      background:rgba(0,0,0,.12);color:rgba(255,255,255,.72);font-size:13px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .lockline b{color:rgba(255,255,255,.9);}
    .lockline .mini-btn{
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);
      padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;color:var(--text);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      background: #111827;
      box-shadow: 0 30px 90px rgba(0,0,0,.75);
      padding: 20px;
      transform: translateY(30px);
      opacity: 0;
      transition: all .25s ease;
    }
    .modal-backdrop.show .modal{
      transform: translateY(0);
      opacity: 1;
    }
    .modal-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .modal-title{font-weight:900;letter-spacing:.2px;font-size:16px;}
    .modal-sub{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.35;}
    .icon-btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      color: var(--text);
    }
    .modal-actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .small-note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35;}
    .success{
      border:1px solid rgba(70,211,154,.30);
      background: rgba(70,211,154,.10);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.92);
      display:none;
      margin-top: 10px;
      font-size: 13px;
    }
    .modal-error{
      border:1px solid rgba(255,91,107,.35);
      background: rgba(255,91,107,.10);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.92);
      display:none;
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.35;
    }

    /* Stars */
    .stars{
      display:flex;
      gap:10px;
      justify-content:center;
      margin: 6px 0 0;
      user-select:none;
    }
    .star{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:22px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .star:active{transform: translateY(1px);}
    .star.on{
      background: rgba(241,194,76,.18);
      border-color: rgba(241,194,76,.40);
      box-shadow: 0 0 0 3px rgba(241,194,76,.12);
    }

    @media (max-width:640px){
      .grid{grid-template-columns:1fr 1fr;}
      .grid-3{grid-template-columns:1fr;}
      .footer-actions{grid-template-columns:1fr;}
      .stats{grid-template-columns:1fr 1fr;}
      .modal-actions{grid-template-columns: 1fr;}
      .star{width:44px;height:44px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div><h1 id="appTitle">Timaro Preview</h1></div>
      <div class="pill">offline â€¢ anonym</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div class="badge" id="modeBadge"><strong>Neu</strong> â€“ Tag erfassen</div>
        <div class="badge">Heute: <strong id="nowText">--:--</strong></div>
      </div>

      <div class="grid">
        <div class="field">
          <label for="date">Datum</label>
          <input id="date" type="date" />
        </div>

        <div class="field">
          <label for="wage">Stundenlohn (â‚¬)</label>
          <input id="wage" type="number" inputmode="decimal" step="0.01" min="0" placeholder="z.B. 18" />
        </div>

        <div class="field">
          <label for="start">Beginn</label>
          <input id="start" type="time" />
        </div>

        <div class="field">
          <label>Ende</label>
          <div class="row">
            <input id="end" type="time" style="flex:1;" />
            <button class="btn btn-small" id="btnNow" type="button">Jetzt</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid-3">
        <div class="field">
          <label for="plan">Sollstunden/Tag (HH:MM)</label>
          <input id="plan" type="text" inputmode="numeric" placeholder="z.B. 08:45" />
          <div class="hint">Tipp: Moâ€“Do automatisch 08:45, Fr 04:00 (kannst du Ã¤ndern).</div>
        </div>

        <div class="field">
          <label for="break">Pause (min)</label>
          <select id="break"></select>
        </div>

        <div class="field">
          <label for="travel">Fahrzeit (min)</label>
          <select id="travel"></select>
        </div>
      </div>

      <div class="error" id="errorBox"></div>

      <div class="stats">
        <div class="stat"><div class="k">Stunden heute</div><div class="v" id="hoursToday">â€”</div></div>
        <div class="stat"><div class="k">Ãœberstunden heute</div><div class="v" id="otToday">â€”</div></div>
        <div class="stat"><div class="k">Wert heute (â‚¬)</div><div class="v" id="valueToday">â€”</div></div>
        <div class="stat locked"><div class="k">Monat Ãœberstunden</div><div class="v">ðŸ”’</div></div>
      </div>

      <div class="footer-actions">
        <button class="btn btn-primary" id="btnSave" type="button">Tag speichern</button>
        <button class="btn" id="btnClear" type="button">Leeren</button>
      </div>

      <div class="hint" style="margin-top:12px;">
        Das ist nur der <strong>Vorgeschmack</strong>. In der Vollversion: Monats-/WochenÃ¼bersicht, PDF-Report, unbegrenzte Historie & Sync.
      </div>

      <div class="lockline">
        <div>ðŸ”’ <b>WochenÃ¼bersicht</b> â€¢ ðŸ”’ <b>MonatsÃ¼bersicht</b> â€¢ ðŸ”’ <b>PDF Report</b> â€¢ ðŸ”’ <b>Unbegrenzte Historie</b></div>
        <button class="mini-btn" id="btnWaitlistTop" type="button">Zur Warteliste</button>
      </div>

      <div class="footer-actions" style="margin-top:12px;">
        <button class="btn btn-primary" id="btnWaitlist" type="button">Zur Warteliste / Early Access</button>
        <button class="btn" id="btnFeedback" type="button">Feedback geben</button>
      </div>

      <div class="list">
        <h2>Letzte 3 Tage (Preview)</h2>
        <div id="recentList"></div>
      </div>

      <div class="footer-actions" style="margin-top:12px;">
        <button class="btn" id="btnDeleteAll" type="button">Alle lokalen Daten lÃ¶schen</button>
        <button class="btn locked" type="button">Sync aktivieren ðŸ”’</button>
      </div>
    </div>
  </div>

  <!-- WAITLIST MODAL -->
  <div class="modal-backdrop" id="waitlistBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="waitlistTitle">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="waitlistTitle">Timaro Early Access</div>
          <div class="modal-sub">Trag deine E-Mail ein â€“ du bekommst als Erstes die Vollversion.</div>
        </div>
        <button class="icon-btn" id="btnCloseWaitlist" type="button">âœ•</button>
      </div>

      <div class="field">
        <label for="waitlistEmail">E-Mail</label>
        <input id="waitlistEmail" type="email" inputmode="email" placeholder="z.B. name@mail.com" autocomplete="email" />
      </div>

      <div class="modal-error" id="waitlistErr"></div>
      <div class="success" id="waitlistOk">Danke! Du bist auf der Liste âœ…</div>

      <div class="modal-actions">
        <button class="btn" id="btnCancelWaitlist" type="button">Abbrechen</button>
        <button class="btn btn-primary" id="btnSubmitWaitlist" type="button">Eintragen</button>
      </div>

      <div class="small-note">
        Hinweis: In dieser Preview speichern wir nur anonym lokal. Keine PasswÃ¶rter, kein Login.
      </div>

      <iframe name="hidden_waitlist_iframe" style="display:none;"></iframe>
      <form id="hiddenWaitlistForm" method="POST" target="hidden_waitlist_iframe" style="display:none;"></form>
    </div>
  </div>

  <!-- FEEDBACK MODAL -->
  <div class="modal-backdrop" id="feedbackBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="feedbackTitle">Kurzes Feedback</div>
          <div class="modal-sub">Wie hilfreich ist Timaro bisher?</div>
        </div>
        <button class="icon-btn" id="btnCloseFeedback" type="button">âœ•</button>
      </div>

      <div class="field">
        <label>Bewertung</label>
        <div class="stars" id="stars">
          <div class="star" data-v="1">â˜…</div>
          <div class="star" data-v="2">â˜…</div>
          <div class="star" data-v="3">â˜…</div>
          <div class="star" data-v="4">â˜…</div>
          <div class="star" data-v="5">â˜…</div>
        </div>
        <div class="hint" style="text-align:center;margin-top:8px;">
          AusgewÃ¤hlt: <strong id="ratingText">â€”</strong>
        </div>
      </div>

      <div class="field">
        <label for="fbComment">Was fehlt dir am meisten? (optional)</label>
        <textarea id="fbComment" placeholder="z.B. MonatsÃ¼bersicht, DiÃ¤ten, Export, ..."></textarea>
      </div>

      <div class="modal-error" id="fbErr"></div>
      <div class="success" id="fbOk">Danke! Feedback ist gespeichert âœ…</div>

      <div class="modal-actions">
        <button class="btn" id="btnCancelFeedback" type="button">SpÃ¤ter</button>
        <button class="btn btn-primary" id="btnSubmitFeedback" type="button">Absenden</button>
      </div>

      <div class="small-note">
        Wird automatisch nach 2 gespeicherten Tagen gefragt (nur 1x).
        <br><br>
        Test-Reset: Halte oben auf â€žTimaro Previewâ€œ 1 Sekunde gedrÃ¼ckt.
      </div>

      <iframe name="hidden_feedback_iframe" style="display:none;"></iframe>
      <form id="hiddenFeedbackForm" method="POST" target="hidden_feedback_iframe" style="display:none;"></form>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // WAITLIST
  const WAITLIST_FORM_ID = "1FAIpQLScYcpRW7s2xD5WwuU7uqTB56jeCEfvzPfB8j7ZLUI4m-arlSg";
  const WAITLIST_EMAIL_ENTRY = "entry.767319811";
  const WAITLIST_ACTION = "https://docs.google.com/forms/d/e/" + WAITLIST_FORM_ID + "/formResponse";

  // FEEDBACK
  const FEEDBACK_FORM_ID = "1FAIpQLScE59CCtGl-8k3Z5D7Sda9CZk44INs0ta_NXl54YlPZKRLdXw";
  const FB_RATING_ENTRY = "entry.721657428";
  const FB_COMMENT_ENTRY = "entry.404280932";
  const FEEDBACK_ACTION = "https://docs.google.com/forms/d/e/" + FEEDBACK_FORM_ID + "/formResponse";

  const RECENT_LIMIT = 3;
  const TRAVEL_COUNTS_AS_WORK = true;
  const NOW_ROUND_MIN = 5;

  const LS_KEY = "timaro.entries.preview.v1";
  const LS_WAITLIST_EMAILS = "timaro.waitlist.emails.v1";
  const LS_FEEDBACK_GIVEN = "timaro.feedback.given.v1";

  const $ = (id)=>document.getElementById(id);
  const pad = (n)=>String(n).padStart(2,"0");
  const toISODate = (d)=>d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
  const todayISO = ()=>toISODate(new Date());
  const nowHHMM = ()=>{ const d=new Date(); return pad(d.getHours())+":"+pad(d.getMinutes()); };

  function roundToMin(date, step){
    const ms = 1000*60;
    const t = Math.round(date.getTime()/(ms*step))*(ms*step);
    return new Date(t);
  }
  function parseHHMM(str){
    if(!str) return null;
    const s=String(str).trim();
    const m=s.match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    const hh=Number(m[1]), mm=Number(m[2]);
    if(hh<0||hh>23||mm<0||mm>59) return null;
    return {hh,mm};
  }
  function minutesFromHHMM(str){
    const p=parseHHMM(str);
    return p ? (p.hh*60+p.mm) : null;
  }
  function minutesBetween(start, end){
    const s=parseHHMM(start), e=parseHHMM(end);
    if(!s||!e) return null;
    return (e.hh*60+e.mm) - (s.hh*60+s.mm);
  }
  function fmtHours(mins){
    const sign = mins < 0 ? "-" : "";
    const a = Math.abs(mins);
    return sign + Math.floor(a/60) + ":" + pad(a%60);
  }
  function fmtMoney(v){
    if(!Number.isFinite(v)) return "â€”";
    return v.toFixed(2).replace(".", ",");
  }

  function loadEntries(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveEntries(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

  function loadEmailSet(){
    try { return JSON.parse(localStorage.getItem(LS_WAITLIST_EMAILS) || "[]"); }
    catch(e){ return []; }
  }
  function saveEmailSet(arr){
    localStorage.setItem(LS_WAITLIST_EMAILS, JSON.stringify(arr));
  }

  function isValidEmail(email){
    const e = String(email||"").trim();
    if(e.length < 5 || e.length > 120) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(e);
  }
  function normalizeEmail(email){ return String(email||"").trim().toLowerCase(); }

  // Refs
  const dateEl = $("date");
  const wageEl = $("wage");
  const startEl = $("start");
  const endEl = $("end");
  const planEl = $("plan");
  const breakEl = $("break");
  const travelEl = $("travel");

  const btnNow = $("btnNow");
  const btnSave = $("btnSave");
  const btnClear = $("btnClear");
  const btnDeleteAll = $("btnDeleteAll");

  const btnWaitlist = $("btnWaitlist");
  const btnWaitlistTop = $("btnWaitlistTop");

  const hoursTodayEl = $("hoursToday");
  const otTodayEl = $("otToday");
  const valueTodayEl = $("valueToday");
  const errorBox = $("errorBox");
  const recentList = $("recentList");
  const modeBadge = $("modeBadge");
  const nowText = $("nowText");

  function setError(msg, ok, showJump){
    if(!msg){
      errorBox.style.display="none";
      errorBox.classList.remove("ok");
      errorBox.innerHTML="";
      return;
    }
    errorBox.style.display="block";
    if(ok){ errorBox.classList.add("ok"); } else { errorBox.classList.remove("ok"); }

    const safeMsg = String(msg);
    if(showJump){
      errorBox.innerHTML = `
        <div class="line">
          <div>${safeMsg}</div>
          <button class="btn-inline" id="jumpTodayBtn" type="button">Zu heute</button>
        </div>
      `;
      const btn = document.getElementById("jumpTodayBtn");
      if(btn){
        btn.addEventListener("click", ()=>{
          dateEl.value = todayISO();
          loadEntryIfExists();
          window.scrollTo({top:0, behavior:"smooth"});
        });
      }
    }else{
      errorBox.textContent = safeMsg;
    }
  }

  function defaultPlanForDate(dateISO){
    const d=new Date(dateISO+"T00:00:00");
    const day=d.getDay();
    if(day===5) return "04:00";
    if(day===6 || day===0) return "00:00";
    return "08:45";
  }

  function populateMinutes(selectEl, max, step, def){
    selectEl.innerHTML="";
    for(let m=0;m<=max;m+=step){
      const o=document.createElement("option");
      o.value=String(m);
      o.textContent=String(m);
      selectEl.appendChild(o);
    }
    selectEl.value=String(def);
  }

  function applyEndMaxIfToday(){
    const dISO=dateEl.value;
    if(dISO===todayISO()){
      const r=roundToMin(new Date(), NOW_ROUND_MIN);
      endEl.max = pad(r.getHours())+":"+pad(r.getMinutes());
    }else{
      endEl.removeAttribute("max");
    }
  }

  function updateModeBadge(){
    const entries=loadEntries();
    const dISO=dateEl.value;
    if(dISO && entries[dISO]){
      modeBadge.innerHTML="<strong>Bearbeiten</strong> â€“ Eintrag existiert";
    }else{
      modeBadge.innerHTML="<strong>Neu</strong> â€“ Tag erfassen";
    }
  }

  // New saves only TODAY, edits allowed if exists.
  function canSaveSelectedDate(dISO){
    const entries = loadEntries();
    const exists = !!entries[dISO];
    const isToday = dISO === todayISO();
    return isToday || exists;
  }

  function validateDay(){
    const dISO=dateEl.value;
    if(!dISO) return {ok:false,msg:"Bitte Datum auswÃ¤hlen.", jump:false};

    if(!canSaveSelectedDate(dISO)){
      return {
        ok:false,
        msg:"In dieser Preview kannst du nur den heutigen Tag neu speichern.",
        jump:true
      };
    }

    if(!startEl.value) return {ok:false,msg:"Bitte Beginn auswÃ¤hlen.", jump:false};
    if(!endEl.value) return {ok:false,msg:"Bitte Ende auswÃ¤hlen.", jump:false};

    applyEndMaxIfToday();
    if(dISO===todayISO() && endEl.max && endEl.value > endEl.max){
      return {ok:false,msg:"Ende liegt in der Zukunft. FÃ¼r heute ist max. "+endEl.max+" erlaubt.", jump:false};
    }

    const delta=minutesBetween(startEl.value, endEl.value);
    if(delta===null) return {ok:false,msg:"Beginn/Ende bitte als HH:MM wÃ¤hlen.", jump:false};
    if(delta<0) return {ok:false,msg:"Ende darf nicht vor Beginn liegen.", jump:false};
    if(delta===0) return {ok:false,msg:"Beginn und Ende sind gleich â€“ ergibt 0 Minuten.", jump:false};

    const planMin=minutesFromHHMM(planEl.value);
    if(planMin===null) return {ok:false,msg:"Sollstunden bitte als HH:MM eingeben (z.B. 08:45).", jump:false};

    const pause=Number(breakEl.value||0);
    if(delta - pause < 0) return {ok:false,msg:"Pause ist grÃ¶ÃŸer als die Arbeitszeit â€“ bitte prÃ¼fen.", jump:false};

    return {ok:true,msg:"", jump:false};
  }

  function computeDay(){
    const delta=minutesBetween(startEl.value, endEl.value);
    const planMin=minutesFromHHMM(planEl.value);
    if(delta===null || planMin===null) return null;

    const pause=Number(breakEl.value||0);
    const travel=Number(travelEl.value||0);

    let workMin = delta - pause;
    if(TRAVEL_COUNTS_AS_WORK) workMin += travel;

    const otMin = workMin - planMin;
    const wage = Number(String(wageEl.value).replace(",", "."));
    const value = Number.isFinite(wage) ? (otMin/60)*wage : NaN;

    return {workMin, otMin, value, wage};
  }

  function recompute(){
    updateModeBadge();
    applyEndMaxIfToday();

    const v=validateDay();
    btnSave.disabled=!v.ok;
    btnSave.style.opacity=v.ok?"1":".55";
    btnSave.style.cursor=v.ok?"pointer":"not-allowed";

    if(!v.ok){
      if(dateEl.value || startEl.value || endEl.value || planEl.value){
        setError(v.msg,false,v.jump);
      }
      hoursTodayEl.textContent="â€”";
      otTodayEl.textContent="â€”";
      valueTodayEl.textContent="â€”";
      return;
    }else{
      setError("",false,false);
    }

    const data=computeDay();
    if(!data){
      hoursTodayEl.textContent="â€”";
      otTodayEl.textContent="â€”";
      valueTodayEl.textContent="â€”";
      return;
    }
    hoursTodayEl.textContent = fmtHours(data.workMin);
    otTodayEl.textContent = fmtHours(data.otMin);
    valueTodayEl.textContent = Number.isFinite(data.value) ? fmtMoney(data.value) : "â€”";
  }

  function loadEntryIfExists(){
    const entries=loadEntries();
    const dISO=dateEl.value;
    if(!dISO) return;

    if(entries[dISO]){
      const e=entries[dISO];
      wageEl.value=(e.wage ?? "");
      startEl.value=(e.start ?? "");
      endEl.value=(e.end ?? "");
      planEl.value=(e.plan ?? defaultPlanForDate(dISO));
      breakEl.value=String(e.breakMin ?? 0);
      travelEl.value=String(e.travelMin ?? 0);
      setError("Eintrag fÃ¼r dieses Datum wurde geladen. Du bearbeitest jetzt diesen Tag.", true, false);
    }else{
      planEl.value=defaultPlanForDate(dISO);

      if(dISO !== todayISO()){
        setError("Hinweis: In der Preview kannst du nur den heutigen Tag neu speichern.", false, true);
      } else {
        setError("", false, false);
      }
    }

    updateModeBadge();
    applyEndMaxIfToday();
    recompute();
    renderRecent();
  }

  function renderRecent(){
    const entries=loadEntries();
    const keys = Object.keys(entries).sort().reverse().slice(0, RECENT_LIMIT);

    recentList.innerHTML="";
    if(keys.length===0){
      const div=document.createElement("div");
      div.className="hint";
      div.textContent="Noch keine gespeicherten Tage. (Preview zeigt nur die letzten 3 Tage.)";
      recentList.appendChild(div);
      return;
    }

    for(const iso of keys){
      const e=entries[iso];

      const div=document.createElement("div");
      div.className="item";

      const left=document.createElement("div");
      left.className="left";

      const date=document.createElement("div");
      date.className="date";
      date.textContent=iso;

      const meta=document.createElement("div");
      meta.className="meta";
      meta.textContent =
        "Beginn " + (e.start||"â€”") +
        " â€¢ Ende " + (e.end||"â€”") +
        " â€¢ Stunden " + (Number.isFinite(e.workMin)?fmtHours(e.workMin):"â€”") +
        " â€¢ ÃœS " + (Number.isFinite(e.otMin)?fmtHours(e.otMin):"â€”");

      left.appendChild(date);
      left.appendChild(meta);

      const btn=document.createElement("button");
      btn.className="btn btn-small";
      btn.type="button";
      btn.textContent="Bearbeiten";
      btn.addEventListener("click", ()=>{
        dateEl.value = iso;
        loadEntryIfExists();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      div.appendChild(left);
      div.appendChild(btn);
      recentList.appendChild(div);
    }
  }

  function clearFieldsKeepDate(){
    startEl.value="";
    endEl.value="";
    breakEl.value="30";
    travelEl.value="0";
    planEl.value=defaultPlanForDate(dateEl.value);
    setError("", false, false);
    recompute();
  }

  function setEndToNow(){
    const r=roundToMin(new Date(), NOW_ROUND_MIN);
    endEl.value = pad(r.getHours())+":"+pad(r.getMinutes());
    recompute();
  }

  function deleteAllData(){
    const ok = confirm("Wirklich ALLE lokalen Timaro-Daten lÃ¶schen? (Kann nicht rÃ¼ckgÃ¤ngig gemacht werden)");
    if(!ok) return;
    localStorage.removeItem(LS_KEY);
    setError("Alle lokalen Daten wurden gelÃ¶scht.", true, false);
    renderRecent();
    recompute();
  }

  function tickNow(){
    nowText.textContent = nowHHMM();
    applyEndMaxIfToday();
  }

  // WAITLIST modal
  const waitlistBackdrop = $("waitlistBackdrop");
  const waitlistEmail = $("waitlistEmail");
  const waitlistErr = $("waitlistErr");
  const waitlistOk = $("waitlistOk");
  const btnCloseWaitlist = $("btnCloseWaitlist");
  const btnCancelWaitlist = $("btnCancelWaitlist");
  const btnSubmitWaitlist = $("btnSubmitWaitlist");
  const hiddenWaitlistForm = $("hiddenWaitlistForm");

  function openWaitlist(){
    waitlistErr.style.display="none";
    waitlistOk.style.display="none";
    waitlistBackdrop.style.display="flex";
    requestAnimationFrame(()=> waitlistBackdrop.classList.add("show"));
    setTimeout(()=> waitlistEmail.focus(), 50);
  }
  function closeWaitlist(){
    waitlistBackdrop.classList.remove("show");
    setTimeout(()=>{ waitlistBackdrop.style.display="none"; }, 200);
  }
  function showWaitlistError(msg){
    waitlistOk.style.display="none";
    waitlistErr.textContent = msg;
    waitlistErr.style.display="block";
  }

  function waitlistAlreadySubmitted(email){
    const list = loadEmailSet();
    return list.includes(normalizeEmail(email));
  }
  function waitlistMarkSubmitted(email){
    const list = loadEmailSet();
    const n = normalizeEmail(email);
    if(!list.includes(n)){
      list.push(n);
      saveEmailSet(list);
    }
  }

  function submitWaitlist(email){
    hiddenWaitlistForm.innerHTML = "";
    hiddenWaitlistForm.setAttribute("action", WAITLIST_ACTION);

    const inp = document.createElement("input");
    inp.type = "hidden";
    inp.name = WAITLIST_EMAIL_ENTRY;
    inp.value = email;
    hiddenWaitlistForm.appendChild(inp);

    hiddenWaitlistForm.submit();
  }

  function onSubmitWaitlist(){
    const email = normalizeEmail(waitlistEmail.value);

    if(!isValidEmail(email)){
      showWaitlistError("Bitte gib eine gÃ¼ltige E-Mail ein.");
      return;
    }
    if(waitlistAlreadySubmitted(email)){
      showWaitlistError("Diese E-Mail ist auf diesem GerÃ¤t bereits eingetragen âœ…");
      return;
    }

    btnSubmitWaitlist.disabled = true;
    btnSubmitWaitlist.style.opacity = ".7";
    btnSubmitWaitlist.textContent = "Speichereâ€¦";

    waitlistMarkSubmitted(email);
    try{ submitWaitlist(email); }catch(e){}

    waitlistErr.style.display="none";
    waitlistOk.style.display="block";

    setTimeout(()=>{
      btnSubmitWaitlist.disabled = false;
      btnSubmitWaitlist.style.opacity = "1";
      btnSubmitWaitlist.textContent = "Eintragen";
      closeWaitlist();
    }, 900);
  }

  // FEEDBACK modal
  const feedbackBackdrop = $("feedbackBackdrop");
  const starsWrap = $("stars");
  const ratingText = $("ratingText");
  const fbComment = $("fbComment");
  const fbErr = $("fbErr");
  const fbOk = $("fbOk");
  const btnCloseFeedback = $("btnCloseFeedback");
  const btnCancelFeedback = $("btnCancelFeedback");
  const btnSubmitFeedback = $("btnSubmitFeedback");
  const hiddenFeedbackForm = $("hiddenFeedbackForm");

  let fbRating = 0;
  let feedbackShowing = false;

  function hasGivenFeedback(){
    return localStorage.getItem(LS_FEEDBACK_GIVEN) === "1";
  }
  function markFeedbackGiven(){
    localStorage.setItem(LS_FEEDBACK_GIVEN, "1");
  }

  function paintStars(val){
    const nodes = starsWrap.querySelectorAll(".star");
    nodes.forEach(n=>{
      const v = Number(n.getAttribute("data-v") || 0);
      if(v <= val) n.classList.add("on");
      else n.classList.remove("on");
    });
    ratingText.textContent = val ? (val + " / 5") : "â€”";
  }

  function openFeedback(){
    if(feedbackShowing) return;
    if(hasGivenFeedback()) return;

    fbErr.style.display="none";
    fbOk.style.display="none";
    fbRating = 0;
    fbComment.value = "";
    paintStars(0);

    feedbackBackdrop.style.display="flex";
    requestAnimationFrame(()=> feedbackBackdrop.classList.add("show"));
    feedbackShowing = true;
  }
  function closeFeedback(){
    feedbackBackdrop.classList.remove("show");
    setTimeout(()=>{ feedbackBackdrop.style.display="none"; }, 200);
    feedbackShowing = false;
  }
  function showFbError(msg){
    fbOk.style.display="none";
    fbErr.textContent = msg;
    fbErr.style.display="block";
  }

  function submitFeedback(){
    if(hasGivenFeedback()){
      closeFeedback();
      return;
    }
    if(!(fbRating >= 1 && fbRating <= 5)){
      showFbError("Bitte wÃ¤hle 1â€“5 Sterne.");
      return;
    }

    btnSubmitFeedback.disabled = true;
    btnSubmitFeedback.style.opacity = ".7";
    btnSubmitFeedback.textContent = "Sendeâ€¦";

    hiddenFeedbackForm.innerHTML = "";
    hiddenFeedbackForm.setAttribute("action", FEEDBACK_ACTION);

    const r = document.createElement("input");
    r.type="hidden";
    r.name = FB_RATING_ENTRY;
    r.value = String(fbRating);
    hiddenFeedbackForm.appendChild(r);

    const cText = String(fbComment.value || "").trim();
    if(cText){
      const c = document.createElement("input");
      c.type="hidden";
      c.name = FB_COMMENT_ENTRY;
      c.value = cText;
      hiddenFeedbackForm.appendChild(c);
    }

    try{ hiddenFeedbackForm.submit(); }catch(e){}
    markFeedbackGiven();

    fbErr.style.display="none";
    fbOk.style.display="block";

    setTimeout(()=>{
      btnSubmitFeedback.disabled = false;
      btnSubmitFeedback.style.opacity = "1";
      btnSubmitFeedback.textContent = "Absenden";
      closeFeedback();
    }, 900);
  }

  function maybeTriggerFeedbackAfterSave(updatedEntries){
    if(hasGivenFeedback()) return;
    const count = Object.keys(updatedEntries || {}).length;
    if(count >= 2){
      setTimeout(()=> openFeedback(), 180);
    }
  }

  function saveCurrent(){
    const v=validateDay();
    if(!v.ok){ setError(v.msg,false,v.jump); return; }
    const data=computeDay();
    if(!data) return;

    const entries=loadEntries();
    const dISO=dateEl.value;

    entries[dISO]={
      wage: Number.isFinite(data.wage) ? data.wage : null,
      start: startEl.value,
      end: endEl.value,
      plan: planEl.value.trim(),
      breakMin: Number(breakEl.value||0),
      travelMin: Number(travelEl.value||0),
      workMin: data.workMin,
      otMin: data.otMin,
      savedAt: Date.now()
    };

    saveEntries(entries);
    setError("Gespeichert âœ… (Wenn es den Tag schon gab, wurde er Ã¼berschrieben.)", true, false);
    renderRecent();
    recompute();

    maybeTriggerFeedbackAfterSave(entries);
  }

  function init(){
    populateMinutes(breakEl, 180, 5, 30);
    populateMinutes(travelEl, 360, 5, 0);

    dateEl.value = todayISO();
    planEl.value = defaultPlanForDate(dateEl.value);

    tickNow();
    setInterval(tickNow, 15000);

    dateEl.addEventListener("change", loadEntryIfExists);
    dateEl.addEventListener("input", loadEntryIfExists);

    wageEl.addEventListener("input", recompute);
    startEl.addEventListener("input", recompute);
    endEl.addEventListener("input", recompute);
    breakEl.addEventListener("change", recompute);
    travelEl.addEventListener("change", recompute);

    planEl.addEventListener("blur", ()=>{
      const p=parseHHMM(planEl.value);
      if(p) planEl.value = pad(p.hh)+":"+pad(p.mm);
      recompute();
    });
    planEl.addEventListener("input", recompute);

    btnNow.addEventListener("click", setEndToNow);
    btnSave.addEventListener("click", saveCurrent);
    btnClear.addEventListener("click", clearFieldsKeepDate);
    btnDeleteAll.addEventListener("click", deleteAllData);

    // Waitlist
    btnWaitlist.addEventListener("click", openWaitlist);
    btnWaitlistTop.addEventListener("click", openWaitlist);
    btnCloseWaitlist.addEventListener("click", closeWaitlist);
    btnCancelWaitlist.addEventListener("click", closeWaitlist);
    waitlistBackdrop.addEventListener("click", (e)=>{ if(e.target === waitlistBackdrop) closeWaitlist(); });
    btnSubmitWaitlist.addEventListener("click", onSubmitWaitlist);
    waitlistEmail.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); onSubmitWaitlist(); }
      if(e.key === "Escape"){ e.preventDefault(); closeWaitlist(); }
    });

    // Feedback button ALWAYS works
    const fbBtn = document.getElementById("btnFeedback");
    if(fbBtn){
      fbBtn.addEventListener("click", openFeedback);
    }

    btnCloseFeedback.addEventListener("click", closeFeedback);
    btnCancelFeedback.addEventListener("click", closeFeedback);
    feedbackBackdrop.addEventListener("click", (e)=>{ if(e.target === feedbackBackdrop) closeFeedback(); });
    btnSubmitFeedback.addEventListener("click", submitFeedback);

    starsWrap.addEventListener("click", (e)=>{
      const t = e.target.closest(".star");
      if(!t) return;
      fbRating = Number(t.getAttribute("data-v") || 0);
      paintStars(fbRating);
      fbErr.style.display="none";
    });

    // Test-Reset: long-press title
    const title = document.getElementById("appTitle");
    if(title){
      let pressTimer = null;
      title.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => {
          localStorage.removeItem(LS_FEEDBACK_GIVEN);
          alert("Feedback-Status zurÃ¼ckgesetzt âœ… (Du kannst es wieder testen)");
        }, 900);
      }, {passive:true});
      title.addEventListener("touchend", () => {
        if(pressTimer) clearTimeout(pressTimer);
      });
    }

    loadEntryIfExists();
    renderRecent();
    recompute();
  }

  init();
})();
</script>
</body>
</html>